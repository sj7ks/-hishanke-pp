<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√úhishanke Mega Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Header -->
  <header>√úhishanke Mega Shop</header>

  <!-- Top Bar -->
  <div class="top-bar">
    <input type="text" id="searchInput" placeholder="Search products...">
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="et">Eesti</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
    <button id="bugReportBtn">Report Bug</button>
    <button id="cartBtn">Cart üõí (<span id="cartCount">0</span>)</button>
  </div>

  <!-- Top 10 Most Bought -->
  <section>
    <h2 style="text-align:center; margin:1rem 0;">Top 10 Most Bought</h2>
    <div class="top10-container" id="top10Container">
      <!-- Dynamically filled -->
    </div>
  </section>

  <!-- Products Grid -->
  <div class="products-container" id="productsContainer">
    <!-- Dynamically filled -->
  </div>

  <!-- Cart Sidebar -->
  <div id="cartSidebar" class="cart-sidebar">
    <h3>Your Cart</h3>
    <div id="cartItems"></div>
    <p>Total: $<span id="cartTotal">0</span></p>
    <button id="checkoutBtn">Buy Now</button>
    <button id="closeCartBtn">Close</button>
  </div>

  <!-- Product Details Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3 id="modalName"></h3>
      <img id="modalImage" src="" alt="" style="width:200px;height:200px;">
      <p id="modalPrice"></p>
      <p id="modalStock"></p>
      <p id="modalDesc"></p>
      <button id="modalAddCart">Add to Cart</button>
      <button id="modalFavorite">‚ù§Ô∏è Favorite</button>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Footer -->
  <footer>¬© 2025 √úhishanke Mega Shop</footer>

  <script src="products.js"></script>
  <script src="app.js"></script>
  <script>
    // Fetch products and render
    let allProducts = [];
    let userId = "guest123"; // For now, simple guest user

    const productsContainer = document.getElementById('productsContainer');
    const top10Container = document.getElementById('top10Container');
    const cartSidebar = document.getElementById('cartSidebar');
    const cartItemsEl = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCountEl = document.getElementById('cartCount');
    const notification = document.getElementById('notification');

    async function fetchProducts() {
      const res = await fetch(`/products?userId=${userId}`);
      allProducts = await res.json();
      renderTop10();
      renderProducts(allProducts);
    }

    function showNotification(msg){
      notification.innerText = msg;
      notification.style.display = "block";
      setTimeout(()=>{notification.style.display="none"},2000);
    }

    function renderProducts(products){
      productsContainer.innerHTML = "";
      products.forEach(p=>{
        const card = document.createElement('div');
        card.className="product-card";
        card.innerHTML=`
          <img src="${p.image||''}" alt="${p.name}">
          <h3>${p.name}</h3>
          <p>Price: $${p.price}</p>
          <p class="stock-info">${p.stock>0?p.stock:'No Stock'}</p>
          <div class="quantity-container">
            <button class="minusBtn">-</button>
            <input type="number" class="quantity-input" value="1" min="1" max="${p.stock}">
            <button class="plusBtn">+</button>
          </div>
          <div class="product-buttons">
            <button class="addCartBtn">Add to Cart</button>
            <button class="check-btn">Check</button>
          </div>
        `;
        // Events
        const plus = card.querySelector('.plusBtn');
        const minus = card.querySelector('.minusBtn');
        const qtyInput = card.querySelector('.quantity-input');
        plus.onclick = ()=>{ if(qtyInput.value< p.stock) qtyInput.value++; updateTotal(); };
        minus.onclick = ()=>{ if(qtyInput.value>1) qtyInput.value--; updateTotal(); };
        card.querySelector('.addCartBtn').onclick = ()=>addToCart(p.id,parseInt(qtyInput.value));
        card.querySelector('.check-btn').onclick = ()=>checkStock(p.id);
        card.querySelector('img').onclick = ()=>openProductModal(p);
        productsContainer.appendChild(card);
      });
    }

    async function checkStock(productId){
      const res = await fetch('/check-product',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ productId, userId })
      });
      const data = await res.json();
      if(data.ok) showNotification(`Stock: ${data.product.stock}`);
      else showNotification(data.error);
      fetchProducts();
    }

    let cart = [];

    function updateCartUI(){
      cartItemsEl.innerHTML = "";
      let total=0;
      cart.forEach(item=>{
        const p = allProducts.find(x=>x.id===item.productId);
        const div = document.createElement('div');
        div.innerHTML = `${p.name} x ${item.quantity} - $${p.price*item.quantity}`;
        cartItemsEl.appendChild(div);
        total += p.price*item.quantity;
      });
      cartTotalEl.innerText = total;
      cartCountEl.innerText = cart.length;
    }

    async function addToCart(productId,quantity){
      const res = await fetch('/buy-product',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ productId, quantity, userId })
      });
      const data = await res.json();
      if(data.ok){
        cart = data.cart;
        updateCartUI();
        showNotification('Added to cart!');
        fetchProducts();
      }else showNotification(data.error);
    }

    function renderTop10(){
      top10Container.innerHTML="";
      const top10 = allProducts.slice(0,10);
      top10.forEach(p=>{
        const card = document.createElement('div');
        card.className="product-card";
        card.style.width="180px";
        card.innerHTML=`<img src="${p.image}" alt="${p.name}"><h4>${p.name}</h4>`;
        top10Container.appendChild(card);
      });
      top10Container.style.display="flex";
      top10Container.style.overflowX="auto";
      top10Container.style.gap="1rem";
      top10Container.style.padding="1rem";
      top10Container.style.scrollSnapType="x mandatory";
      Array.from(top10Container.children).forEach(c=>c.style.scrollSnapAlign="center");
    }

    // Cart sidebar toggle
    document.getElementById('cartBtn').onclick=()=>cartSidebar.style.display='block';
    document.getElementById('closeCartBtn').onclick=()=>cartSidebar.style.display='none';
    document.getElementById('checkoutBtn').onclick=()=>showNotification('Checkout not implemented');

    // Product Modal
    const productModal = document.getElementById('productModal');
    const modalName = document.getElementById('modalName');
    const modalImage = document.getElementById('modalImage');
    const modalPrice = document.getElementById('modalPrice');
    const modalStock = document.getElementById('modalStock');
    const modalDesc = document.getElementById('modalDesc');
    const modalAddCart = document.getElementById('modalAddCart');

    function openProductModal(p){
      modalName.innerText=p.name;
      modalImage.src=p.image||'';
      modalPrice.innerText=`Price: $${p.price}`;
      modalStock.innerText=`Stock: ${p.stock}`;
      modalDesc.innerText=p.description||"No description";
      modalAddCart.onclick=()=>addToCart(p.id,1);
      productModal.style.display='flex';
    }
    document.querySelector('.close-modal').onclick=()=>productModal.style.display='none';
    window.onclick=(e)=>{ if(e.target==productModal) productModal.style.display='none'; }

    // Bug report
    document.getElementById('bugReportBtn').onclick=()=>{
      const msg = prompt("Describe the bug:");
      if(msg) fetch('/report-bug',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, message: msg })
      }).then(()=>showNotification('Bug reported!'));
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', e=>{
      const query = e.target.value.toLowerCase();
      renderProducts(allProducts.filter(p=>p.name.toLowerCase().includes(query)));
    });

    fetchProducts();
  </script>
</body>
</html>